<!doctype html> 
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Im√≥veis</title>
  <meta name="description" content="Digital Im√≥veis - gest√£o e contato r√°pido entre leads e corretores" />
  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --success:#10b981;
      --max-width:1100px; --radius:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#0f172a;line-height:1.4}
    header{background:linear-gradient(90deg,#0ea5e9 0%, #2563eb 100%);color:white;padding:28px 16px}
    .wrap{max-width:var(--max-width);margin:0 auto}
    header .title{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px;letter-spacing:0.2px}
    header p{margin:4px 0 0;font-size:13px;opacity:.95}
    main{padding:28px 16px}
    .controls{display:flex;gap:12px;align-items:center;margin:18px 0;flex-wrap:wrap}
    .search{flex:1;min-width:220px}
    input[type="search"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6eef6;background:white}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.06);display:flex;flex-direction:column}
    .thumb{height:160px;background:#ddd;background-position:center;background-size:cover;position:relative;transition:background-image 0.3s ease;}
    .card-body{padding:12px 14px;flex:1;display:flex;flex-direction:column}
    .price{font-weight:700;color:var(--accent);font-size:18px}
    .addr{font-size:13px;color:var(--muted);margin-top:6px}
    .meta{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.secondary{background:#eef2ff;color:var(--accent);border:1px solid #c7ddff}
    footer{padding:18px 0;text-align:center;color:var(--muted);font-size:13px}
    .loading{text-align:center;padding:40px;font-size:18px;color:var(--muted)}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid #e6eef6;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .badge{position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.95);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;color:#0f172a}

    /* Novos estilos para a navega√ß√£o de imagens */
    .thumb-controls{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;z-index:10;}
    .nav-btn{background:rgba(0,0,0,0.4);color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:16px;line-height:1;transition:background 0.2s;}
    .nav-btn:hover:not(:disabled){background:rgba(0,0,0,0.6);}
    .nav-btn:disabled{opacity:0.0;cursor:default;}
    .image-counter{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;z-index:11;}

    /* Estilos do Drawer de Contato (existente) */
    .contact-drawer{
      position:fixed;
      right:18px;
      bottom:18px;
      width:360px;
      max-width:calc(100% - 36px);
      border-radius:14px;
      background:linear-gradient(180deg,#ffffff, #fbfdff);
      box-shadow:0 18px 48px rgba(7,12,20,0.18);
      overflow:hidden;
      display:none;
      z-index:9998;
    }
    .contact-drawer.open{display:block}
    .drawer-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef2f6}
    .drawer-header h3{margin:0;font-size:15px}
    .drawer-body{padding:12px 14px}
    .field{margin-bottom:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="email"], input[type="tel"], textarea, input[type="datetime-local"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff
    }
    textarea{min-height:80px;resize:vertical}
    .small{font-size:12px;color:#374151}
    .lead-card{background:#f8fafc;border-radius:10px;padding:10px;margin-top:8px;border:1px solid #eef2f6}
    .prompt-box{background:#0b1220;color:white;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;}
    .copy-btn{background:#fff;color:#0b1220;padding:6px 8px;border-radius:8px;border:none;cursor:pointer}

    .float-btn{
      position:fixed;
      right:20px;
      bottom:20px;
      background:#2563eb;
      color:white;
      padding:12px 18px;
      border:none;
      border-radius:50px;
      box-shadow:0 8px 22px rgba(0,0,0,0.22);
      cursor:pointer;
      font-size:14px;
      z-index:9999;
    }

    /* Novo: Caixa de Mensagem para Detalhes */
    #messageBox {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      max-width: 90%;
      display: none;
      font-size: 14px;
      line-height: 1.6;
    }
    #messageBox button {
      margin-top: 10px;
      background: var(--accent);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }


    @media (max-width:640px){
      .contact-drawer{right:12px;left:12px;bottom:12px;width:auto}
      header h1{font-size:18px}
      #messageBox{bottom: 12px; padding: 12px 18px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="white" opacity=".08"></rect><path d="M6 11.5L12 7l6 4.5V18a1 1 0 0 1-1 1h-3v-4H10v4H7a1 1 0 0 1-1-1v-6.5z" fill="white"></path></svg>
        <div>
          <h1>Digital Im√≥veis</h1>
          <p>Descubra im√≥veis reais ‚Äî entre em contato e agende visitas.</p>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="controls">
      <div class="search">
        <input id="q" type="search" placeholder="Buscar por cidade ou palavra-chave" />
      </div>
      <div style="width:160px">
        <select id="filter">
          <option value="todos">Todos os im√≥veis</option>
          <option value="Apartamento">Apartamento</option>
          <option value="Casa">Casa</option>
          <option value="Sobrado">Sobrado</option>
          <option value="Terreno">Terreno</option>
          <option value="Comercial">Comercial</option>
        </select>
      </div>
      <div style="width:140px"><input id="maxPrice" type="text" placeholder="Pre√ßo m√°x. (R$)" /></div>
      <div><button id="searchBtn" class="btn">Buscar</button></div>
    </div>

    <div id="loading" class="loading" style="display:block">
      <div class="spinner"></div>
      <p>Carregando im√≥veis do banco de dados...</p>
    </div>

    <section id="list" class="grid" aria-live="polite"></section>

    <footer>
      ¬© <span id="year"></span> Digital Im√≥veis ‚Äî Sistema integrado com backend
    </footer>
  </main>
  
  <div id="messageBox" style="display:none;">
    <div id="messageContent"></div>
    <button onclick="fecharMessageBox()">Fechar</button>
  </div>

  <aside class="contact-drawer" aria-label="Formul√°rio de contato">
    <div class="drawer-header">
      <h3>Contato r√°pido</h3>
      <button onclick="fecharDrawer()" style="font-size:18px;background:none;border:none;cursor:pointer;color:#6b7280">‚úï</button>
    </div>
    <div class="drawer-body">
      <div class="field">
        <label for="name">Nome</label>
        <input id="name" type="text" placeholder="Seu nome" required />
      </div>
      <div class="field">
        <label for="email">E-mail</label>
        <input id="email" type="email" placeholder="seu@email.com" required />
      </div>
      <div class="field">
        <label for="phone">Telefone</label>
        <input id="phone" type="tel" placeholder="(11) 9xxxx-xxxx" required />
      </div>
      <div class="field">
        <label for="property">Im√≥vel de interesse (opcional)</label>
        <input id="property" type="text" placeholder="Ex: Casa - Rua A, 123" />
      </div>
      <div class="field">
        <label for="datetime">Prefer√™ncia de dia/hora</label>
        <input id="datetime" type="datetime-local" />
      </div>
      <div class="field">
        <label for="message">Mensagem</label>
        <textarea id="message" placeholder="Escreva sua mensagem..."></textarea>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="sendLead" class="btn">Enviar mensagem</button>
        <button id="clearForm" class="btn secondary">Limpar</button>
      </div>

      <div id="leadResult" class="lead-card small" style="display:none"></div>

      <div id="promptArea" style="display:none">
        <div style="margin-top:10px;font-size:13px;color:var(--muted)">Prompt sugerido para o corretor:</div>
        <div class="prompt-box" id="agentPrompt"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="copyPrompt" class="copy-btn">Copiar prompt</button>
          <button id="openWhats" class="copy-btn">Abrir WhatsApp</button>
        </div>
      </div>
    </div>
  </aside>

  <button id="openDrawer" class="float-btn">Contato r√°pido</button>

  <script>
    // ========== CONFIGURA√á√ÉO ==========
    const API_URL_LEADS = 'http://localhost:3000/api/leads';
    const API_URL_IMOVEIS = 'http://localhost:3000/api/imoveis';
    
    let allProperties = []; // Im√≥veis do banco
    const agents = [
      { id: 'AG001', name: 'Jo√£o Silva', phone: '+5511999000001' },
      { id: 'AG002', name: 'Mariana Alves', phone: '+5511999000002' },
      { id: 'AG003', name: 'Carlos Pereira', phone: '+5511999000003' }
    ];

    const listEl = document.getElementById('list');
    const loadingEl = document.getElementById('loading');
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    // Fun√ß√µes de controle da caixa de mensagem
    function exibirMessageBox(htmlContent) {
        document.getElementById('messageContent').innerHTML = htmlContent;
        document.getElementById('messageBox').style.display = 'block';
    }

    function fecharMessageBox() {
        document.getElementById('messageBox').style.display = 'none';
    }

    // ========== CARREGAR IM√ìVEIS DO BANCO ==========
    async function loadProperties() {
      try {
        const response = await fetch(API_URL_IMOVEIS);
        const data = await response.json();
        
        if (data.success && data.data) {
          // Garante que o campo 'imagens' √© um array, mesmo que vazio
          allProperties = data.data.filter(i => i.disponivel).map(p => ({
            ...p,
            imagens: Array.isArray(p.imagens) ? p.imagens : []
          })); 
          loadingEl.style.display = 'none';
          renderProperties(allProperties);
        } else {
          throw new Error('Erro ao carregar im√≥veis');
        }
      } catch (error) {
        console.error('Erro:', error);
        loadingEl.innerHTML = '<p style="color:#ef4444">‚ùå Erro ao carregar im√≥veis do servidor.<br>Verifique se o backend est√° rodando.</p>';
      }
    }

    // Carregar ao iniciar
    loadProperties();

    function renderProperties(items){
      if (items.length === 0) {
        listEl.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px"><p style="font-size:18px;color:var(--muted)">üèöÔ∏è Nenhum im√≥vel encontrado</p></div>';
        return;
      }

      listEl.innerHTML = '';
      items.forEach(p => {
        const card = document.createElement('article');
        card.className = 'card';
        
        const imgUrls = p.imagens || [];
        const hasMultipleImages = imgUrls.length > 1;

        // URL da primeira imagem, ou um placeholder se n√£o houver nenhuma
        const initialImgUrl = imgUrls.length > 0 
          ? imgUrls[0] 
          : 'https://placehold.co/800x600/cbd5e1/374151?text=Sem+Foto';
        
        // Armazenar as URLs e o √≠ndice no card para navega√ß√£o via JS
        card.setAttribute('data-images', JSON.stringify(imgUrls));
        card.setAttribute('data-current-index', 0);
        
        card.innerHTML = `
          <div class="thumb" style="background-image:url('${initialImgUrl}')">
            <span class="badge">${p.tipo}</span>
            ${hasMultipleImages ? `
              <div class="thumb-controls">
                <button class="nav-btn nav-prev" data-dir="-1" title="Foto anterior">&#10094;</button>
                <button class="nav-btn nav-next" data-dir="1" title="Pr√≥xima foto">&#10095;</button>
              </div>
              <span class="image-counter">1 / ${imgUrls.length}</span>
            ` : ''}
          </div>
          <div class="card-body">
            <div class="price">R$ ${p.preco?.toLocaleString('pt-BR')}</div>
            <div class="addr">${p.cidade}/${p.estado} ‚Ä¢ ${p.metragem}m¬≤</div>
            <div style="font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4">${p.descricao || 'Im√≥vel dispon√≠vel para visita√ß√£o'}</div>
            <div class="meta" style="margin-top:12px">
              <div style="font-size:11px;color:var(--muted)">Ref: ${p.id.slice(0,8)}</div>
              <div style="display:flex;gap:6px">
                <button class="btn" onclick="startContact('${p.id}', '${p.tipo}', '${p.cidade}')">Quero este</button>
                <button class="btn secondary" onclick="viewDetails('${p.id}')">Ver mais</button>
              </div>
            </div>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    // L√≥gica para navega√ß√£o de imagens (Novo)
    function navigateImage(card, direction) {
      const imagesAttr = card.getAttribute('data-images');
      const images = imagesAttr ? JSON.parse(imagesAttr) : [];
      if (images.length < 2) return;

      let currentIndex = parseInt(card.getAttribute('data-current-index') || 0);
      const total = images.length;

      let newIndex = currentIndex + direction;

      // Navega√ß√£o circular
      if (newIndex < 0) {
          newIndex = total - 1; 
      } else if (newIndex >= total) {
          newIndex = 0; 
      }
      
      // Atualiza estado do card
      card.setAttribute('data-current-index', newIndex);

      // Atualiza UI
      const thumbEl = card.querySelector('.thumb');
      if (thumbEl) {
          thumbEl.style.backgroundImage = `url('${images[newIndex]}')`;
      }
      
      const counterEl = card.querySelector('.image-counter');
      if (counterEl) {
          counterEl.textContent = `${newIndex + 1} / ${total}`;
      }
    }

    // Delega√ß√£o de eventos para os bot√µes de navega√ß√£o de imagens (Novo)
    listEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.nav-btn');
      if (btn) {
        e.preventDefault();
        e.stopPropagation(); // Impede que o clique seja propagado para o card inteiro
        const card = btn.closest('.card');
        const direction = parseInt(btn.getAttribute('data-dir'));
        if (card) {
          navigateImage(card, direction);
        }
      }
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const filter = document.getElementById('filter').value;
      const maxP = parseFloat(String(document.getElementById('maxPrice').value).replace(/\D/g,''));
      
      const result = allProperties.filter(p => {
        if(filter !== 'todos' && p.tipo !== filter) return false;
        if(q && !(p.cidade?.toLowerCase().includes(q) || p.endereco?.toLowerCase().includes(q) || p.tipo?.toLowerCase().includes(q))) return false;
        if(!isNaN(maxP) && maxP>0 && p.preco>maxP) return false;
        return true;
      });
      
      renderProperties(result);
    });

    function viewDetails(id){
      const p = allProperties.find(x => x.id === id);
      if(!p) return exibirMessageBox('Im√≥vel n√£o encontrado.');

      const detailsContent = `
        <h4 style="margin:0 0 10px; color:#0ea5e9;">${p.tipo} - ${p.cidade}/${p.estado}</h4>
        <p style="margin:0 0 5px;"><strong>Pre√ßo:</strong> R$ ${p.preco?.toLocaleString('pt-BR')}</p>
        <p style="margin:0 0 5px;"><strong>Metragem:</strong> ${p.metragem}m¬≤</p>
        <p style="margin:0 0 15px;"><strong>Ref:</strong> ${p.id.slice(0,8)}</p>
        <p style="margin:0; border-top: 1px solid #333; padding-top: 10px;">
          <strong>Descri√ß√£o:</strong> ${p.descricao || 'Sem descri√ß√£o detalhada.'}
        </p>
      `;
      exibirMessageBox(detailsContent);
    }

    function startContact(id, tipo, cidade){
      document.getElementById('property').value = `${tipo} - ${cidade} (Ref: ${id.slice(0,8)})`;
      abrirDrawer();
    }

    function abrirDrawer(){
      document.querySelector('.contact-drawer').classList.add('open');
      document.getElementById('name').focus();
    }
    
    function fecharDrawer(){
      document.querySelector('.contact-drawer').classList.remove('open');
    }

    document.getElementById('openDrawer').addEventListener('click', abrirDrawer);

    // ========== ENVIO PARA BACKEND ==========
    document.getElementById('sendLead').addEventListener('click', async () => {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const property = document.getElementById('property').value.trim() || 'Interesse geral';
      const datetime = document.getElementById('datetime').value;
      const message = document.getElementById('message').value.trim();

      if(!name || !email || !phone){
        exibirMessageBox('‚ö†Ô∏è Por favor preencha nome, e-mail e telefone.');
        return;
      }

      const leadData = {
        nome: name,
        email: email,
        telefone: phone,
        origem: 'site'
      };

      const sendBtn = document.getElementById('sendLead');
      const originalText = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = '‚è≥ Enviando...';

      try {
        const response = await fetch(API_URL_LEADS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(leadData)
        });

        const result = await response.json();

        if (result.success) {
          const leadId = result.data.id;
          const status = result.data.status;
          const assigned = agents[Math.floor(Math.random() * agents.length)];

          document.getElementById('leadResult').style.display = 'block';
          document.getElementById('leadResult').innerHTML = `
            ‚úÖ <strong>Sucesso!</strong> Mensagem enviada.<br>
            Lead: <strong>${leadId.slice(0, 8)}</strong> ‚Ä¢ Status: <strong>${status}</strong><br>
            Im√≥vel: ${property}<br>
            Corretor: <strong>${assigned.name}</strong> ‚Ä¢ ${assigned.phone}
          `;
          const prompt = `Ol√° ${assigned.name},\n\n‚ú® Novo lead capturado pelo site!\n\nID: ${leadId}\nNome: ${name}\nTelefone: ${phone}\nEmail: ${email}\nStatus IA: ${status}\nIm√≥vel: ${property}\nData/Hora: ${datetime || 'N√£o informado'}\nMensagem: ${message || '‚Äî'}\n\nüìã A√ß√£o:\n1. Contato em 2h\n2. Confirmar visita\n3. Enviar localiza√ß√£o\n4. Registrar no sistema`;

          document.getElementById('agentPrompt').textContent = prompt;
          document.getElementById('promptArea').style.display = 'block';

          ['name','email','phone','property','datetime','message'].forEach(id => {
            document.getElementById(id).value = '';
          });

          setTimeout(() => {
            fecharDrawer();
            setTimeout(() => {
              document.getElementById('leadResult').style.display = 'none';
              document.getElementById('promptArea').style.display = 'none';
            }, 500);
          }, 2000);

        } else {
          exibirMessageBox('‚ùå Erro: ' + (result.error || 'Erro desconhecido'));
        }

      } catch (error) {
        console.error('Erro:', error);
        exibirMessageBox('‚ùå Erro de conex√£o. Servidor: ' + API_URL_LEADS);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
      }
    });

    document.getElementById('clearForm').addEventListener('click', () => {
      ['name','email','phone','property','datetime','message'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('leadResult').style.display = 'none';
      document.getElementById('promptArea').style.display = 'none';
    });

    document.getElementById('copyPrompt').addEventListener('click', () => {
      const text = document.getElementById('agentPrompt').textContent;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          exibirMessageBox('‚úÖ Prompt copiado!');
        });
      }
    });

    document.getElementById('openWhats').addEventListener('click', () => {
      const txt = encodeURIComponent(document.getElementById('agentPrompt').textContent);
      window.open(`https://web.whatsapp.com/send?text=${txt}`, '_blank');
    });

    document.getElementById('q').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') document.getElementById('searchBtn').click();
    });
  </script>
</body>
</html>