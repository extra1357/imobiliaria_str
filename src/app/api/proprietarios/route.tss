import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// GET - Listar todos os propriet√°rios
export async function GET(request: NextRequest) {
  try {
    const proprietarios = await prisma.proprietario.findMany({
      select: {
        id: true,
        nome: true,
        email: true,
        telefone: true,
        cpf: true,
        createdAt: true,
        updatedAt: true
      },
      orderBy: {
        nome: 'asc'
      }
    });

    console.log(`‚úÖ Retornando ${proprietarios.length} propriet√°rios`);

    return NextResponse.json(proprietarios, {
      status: 200,
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
  } catch (error) {
    console.error('‚ùå Erro ao buscar propriet√°rios:', error);
    return NextResponse.json(
      { error: 'Erro ao buscar propriet√°rios', details: error instanceof Error ? error.message : 'Erro desconhecido' },
      { status: 500 }
    );
  } finally {
    await prisma.$disconnect();
  }
}

// POST - Criar novo propriet√°rio
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();

    console.log('üìù Criando novo propriet√°rio:', body);

    // Valida√ß√µes
    if (!body.nome || !body.email || !body.telefone) {
      return NextResponse.json(
        { error: 'Nome, email e telefone s√£o obrigat√≥rios' },
        { status: 400 }
      );
    }

    // Verifica se email j√° existe
    const emailExiste = await prisma.proprietario.findUnique({
      where: { email: body.email }
    });

    if (emailExiste) {
      return NextResponse.json(
        { error: 'Este email j√° est√° cadastrado' },
        { status: 409 }
      );
    }

    // Verifica se CPF j√° existe (se fornecido)
    if (body.cpf) {
      const cpfExiste = await prisma.proprietario.findUnique({
        where: { cpf: body.cpf }
      });

      if (cpfExiste) {
        return NextResponse.json(
          { error: 'Este CPF j√° est√° cadastrado' },
          { status: 409 }
        );
      }
    }

    // Cria o propriet√°rio
    const novoProprietario = await prisma.proprietario.create({
      data: {
        nome: body.nome,
        email: body.email,
        telefone: body.telefone,
        cpf: body.cpf || null
      }
    });

    console.log(`‚úÖ Propriet√°rio criado: ${novoProprietario.id}`);

    // Registra auditoria
    await prisma.auditoria.create({
      data: {
        acao: 'CREATE',
        tabela: 'Proprietario',
        registroId: novoProprietario.id,
        usuario: 'sistema',
        dados: JSON.stringify({
          nome: novoProprietario.nome,
          email: novoProprietario.email
        })
      }
    });

    return NextResponse.json(novoProprietario, {
      status: 201,
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate'
      }
    });

  } catch (error) {
    console.error('‚ùå Erro ao criar propriet√°rio:', error);
    
    return NextResponse.json(
      { 
        error: 'Erro ao criar propriet√°rio', 
        details: error instanceof Error ? error.message : 'Erro desconhecido' 
      },
      { status: 500 }
    );
  } finally {
    await prisma.$disconnect();
  }
}